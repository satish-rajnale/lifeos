# Automatic Journal Summarization Setup

## ğŸ¯ Overview

This feature **automatically generates AI summaries** for journal entries using a webhook-triggered system. When a user creates a journal entry, it's inserted with raw transcript only, then a webhook triggers an Edge Function that calls OpenAI to generate the summary asynchronously.

## ğŸ—ï¸ Architecture

```
User creates journal entry
         â†“
create-daily-journal Edge Function
         â†“
Insert raw entry (summary=null, is_summarized=false)
         â†“
Database trigger fires
         â†“
Supabase Database Webhook
         â†“
auto-summarize-journal Edge Function
         â†“
OpenAI generates summary
         â†“
Update entry with summary (is_summarized=true)
         â†“
Decrement user credits
```

## ğŸ“Š Database Changes

### New Columns in `journal_entries`:
- `is_summarized` (boolean) - Tracks if entry has been summarized
- `summary` - Now nullable to allow initial insert without summary

### Migration: `009_auto_summarize_trigger.sql`
```sql
- Add is_summarized column
- Make summary nullable
- Create trigger function notify_new_journal_entry()
- Create trigger on_journal_entry_created
```

## ğŸš€ Deployment Steps

### Step 1: Apply Database Migration

```bash
cd supabase
supabase db push
```

This will:
- âœ… Add `is_summarized` column
- âœ… Make `summary` nullable
- âœ… Create database trigger
- âœ… Create notification function

### Step 2: Deploy Edge Functions

```bash
# Deploy the updated create-daily-journal function
supabase functions deploy create-daily-journal

# Deploy the new auto-summarize function
supabase functions deploy auto-summarize-journal
```

### Step 3: Set Webhook Secret

```bash
# Generate a secure random secret
WEBHOOK_SECRET=$(openssl rand -hex 32)

# Set it in Supabase
supabase secrets set WEBHOOK_SECRET=$WEBHOOK_SECRET

# Save this secret - you'll need it for the webhook configuration
echo "Your webhook secret: $WEBHOOK_SECRET"
```

### Step 4: Configure Database Webhook in Supabase Dashboard

1. Go to **Supabase Dashboard** â†’ Your Project â†’ **Database** â†’ **Webhooks**

2. Click **"Create a new webhook"**

3. Configure the webhook:
   ```
   Name: Auto Summarize Journal Entries
   
   Table: journal_entries
   
   Events: INSERT
   
   Type: HTTP Request
   
   Method: POST
   
   URL: https://YOUR_PROJECT_REF.supabase.co/functions/v1/auto-summarize-journal
   
   HTTP Headers:
     - Key: Content-Type
       Value: application/json
     
     - Key: Authorization
       Value: Bearer YOUR_ANON_KEY
     
     - Key: x-webhook-secret
       Value: YOUR_WEBHOOK_SECRET (from Step 3)
   
   Conditions: (optional)
     - column: is_summarized
       operator: eq
       value: false
   ```

4. Click **"Create webhook"**

5. **Test the webhook** with the test button

### Step 5: Verify Setup

Test by creating a journal entry:

```bash
curl -X POST "https://your-project.supabase.co/functions/v1/create-daily-journal" \
  -H "Authorization: Bearer YOUR_USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Today was a productive day. I worked on several projects and made good progress.",
    "date": "2026-01-15"
  }'
```

Expected flow:
1. Returns `202 Accepted` with `"status": "processing"`
2. Entry inserted with `is_summarized: false`
3. Webhook triggers within seconds
4. Summary generated by OpenAI
5. Entry updated with summary and `is_summarized: true`

Check the logs:
- **Edge Functions Logs**: Dashboard â†’ Edge Functions â†’ auto-summarize-journal â†’ Logs
- **Database Webhooks Logs**: Dashboard â†’ Database â†’ Webhooks â†’ View logs

## ğŸ”§ How It Works

### 1. User Creates Journal Entry

**Client calls:**
```typescript
await supabase.functions.invoke('create-daily-journal', {
  body: { text, date }
})
```

### 2. Entry Inserted Without Summary

```sql
INSERT INTO journal_entries (
  user_id, 
  journal_date, 
  date, 
  raw_transcript, 
  summary,  -- NULL
  is_summarized  -- false
)
```

### 3. Database Trigger Notifies

```sql
CREATE TRIGGER on_journal_entry_created
  AFTER INSERT ON journal_entries
  FOR EACH ROW
  WHEN (NEW.summary IS NULL)
  EXECUTE FUNCTION notify_new_journal_entry();
```

### 4. Webhook Calls Edge Function

Supabase sends:
```json
{
  "type": "INSERT",
  "table": "journal_entries",
  "record": {
    "id": "uuid",
    "user_id": "uuid",
    "date": "2026-01-15",
    "raw_transcript": "...",
    "is_summarized": false
  }
}
```

### 5. Edge Function Processes

```typescript
1. Verify webhook secret
2. Check user credits
3. Call OpenAI to generate summary
4. Update journal entry with summary
5. Decrement user credits
```

### 6. Summary Stored

```sql
UPDATE journal_entries
SET 
  summary = '{"day_summary": "...", ...}',
  is_summarized = true
WHERE id = ?
```

## ğŸ” Security

- **Webhook Secret**: Verifies webhook authenticity
- **Service Role Key**: Only edge function can update entries
- **User Credits Check**: Prevents abuse
- **RLS Policies**: Users can only read their own entries

## âš¡ Performance

- **Async Processing**: User gets immediate response (202)
- **Webhook Latency**: < 500ms to trigger
- **OpenAI Latency**: 2-5 seconds
- **Total Time**: Summary ready in 3-6 seconds

## ğŸ’° Costs

**OpenAI (GPT-4o-mini)**:
- ~$0.0001 per journal entry
- ~$0.003 per month (30 entries)

**Supabase Edge Functions**:
- Included in plan (generous free tier)

**Database Webhooks**:
- Included in plan (no extra cost)

## ğŸ§ª Testing

### Test Webhook Manually

```bash
curl -X POST "https://your-project.supabase.co/functions/v1/auto-summarize-journal" \
  -H "Content-Type: application/json" \
  -H "x-webhook-secret: YOUR_WEBHOOK_SECRET" \
  -d '{
    "type": "INSERT",
    "table": "journal_entries",
    "record": {
      "id": "test-uuid",
      "user_id": "user-uuid",
      "date": "2026-01-15",
      "raw_transcript": "Test entry for today",
      "is_summarized": false
    }
  }'
```

### Check Webhook Status

1. Go to Database â†’ Webhooks
2. Click on your webhook
3. View **Recent deliveries**
4. Check status codes:
   - âœ… 200: Success
   - âš ï¸ 401: Invalid webhook secret
   - âŒ 500: Edge function error

## ğŸ› Troubleshooting

### Webhook Not Triggering

**Problem**: Entry created but summary not generated

**Solutions**:
1. Check webhook is enabled in Dashboard
2. Verify webhook URL is correct
3. Check webhook condition (is_summarized = false)
4. View webhook logs for errors

### Summary Not Updated

**Problem**: Webhook triggers but entry not updated

**Solutions**:
1. Check Edge Function logs
2. Verify OPENAI_API_KEY is set
3. Check user has credits
4. Verify Service Role Key is correct

### Invalid Webhook Secret

**Problem**: 401 Unauthorized error

**Solutions**:
1. Verify webhook secret matches in:
   - Supabase webhook configuration
   - Edge function environment variable
2. Regenerate secret if needed

## ğŸ“ Client Code Changes

The client no longer needs to wait for the summary:

**Before** (synchronous):
```typescript
const { data } = await supabase.functions.invoke('create-daily-journal', {
  body: { text, date }
})
// data contains complete summary âœ“
```

**After** (async with polling - optional):
```typescript
// 1. Create entry (returns immediately)
const { data } = await supabase.functions.invoke('create-daily-journal', {
  body: { text, date }
})
// data: { status: 'processing', entry_id: '...' }

// 2. Poll for summary (optional - or just show loading)
const checkSummary = async (entryId) => {
  const { data } = await supabase
    .from('journal_entries')
    .select('summary, is_summarized')
    .eq('id', entryId)
    .single()
  
  if (data.is_summarized) {
    return data.summary // Ready!
  }
  
  // Wait and retry
  await new Promise(r => setTimeout(r, 1000))
  return checkSummary(entryId)
}
```

## ğŸ‰ Benefits

1. **Faster Response**: User doesn't wait for OpenAI (3-5s saved)
2. **Better UX**: Immediate feedback, loading state
3. **Scalable**: Handles spikes without blocking
4. **Reliable**: Retries on failure (webhook handles it)
5. **Decoupled**: Edge function can be updated independently

---

**Your automatic journal summarization is ready! ğŸš€**
